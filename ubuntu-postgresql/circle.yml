machine:
  services:
    - docker
dependencies:
  pre: 
    - sudo service postgresql stop
  cache_directories:
    - "~/ubuntu-postgresql"
  override:
    - docker info
    - for i in $(ls -1 ~/docker-ubuntu-pg |egrep --color "[0-9]{1,2}\.[0-9]{1,2}.*"); do if [[ -e ~/ubuntu-postgresql/$i.tar ]]; then docker load --input ~/ubuntu-postgresql/$i.tar; fi && docker build -t fike/ubuntu-postgresql:$i $i && mkdir -p ~/ubuntu-postgresql && docker save --output ~/ubuntu-postgresql/$i.tar fike/ubuntu-postgresql:$i ; done

test:
  override:
    - for i in $(ls -1 ~/docker-ubuntu-pg |egrep --color "[0-9]{1,2}\.[0-9]{1,2}.*"); do docker run -d --name $i fike/ubuntu-postgresql:$i  && docker run -it --net="container:$i" -e PGPASSWORD="foobar" fike/ubuntu-postgresql:$i psql -h 127.0.0.1 -p 5432  -U postgres --command "SELECT version();" && docker stop $i; done
